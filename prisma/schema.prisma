// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("POSTGRES_URL_NON_POOLING")
}

model User {
  id           String           @id @default(cuid())
  email        String           @unique
  passwordHash String
  name         String?
  plan         Plan             @default(pending)
  isAdmin      Boolean          @default(false)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  // Stripe integration
  stripeCustomerId     String?   @unique
  stripeSubscriptionId String?   @unique
  subscriptionStatus   SubscriptionStatus @default(incomplete)
  subscriptionPriceId  String?
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean   @default(false)

  // Usage tracking (minutes-based)
  minutesUsed       Int       @default(0)  // Minutes used in current period
  minutesLimit      Int       @default(0)  // Total minutes allowed (plan + credits)
  bonusMinutes      Int       @default(0)  // Extra purchased minutes
  lastUsageReset    DateTime?              // When usage was last reset

  sessions           Session[]
  apiKeys            ApiKey[]
  reviews            Review[]
  generatedVideos    GeneratedVideo[]
  actorPresets       ActorPreset[]
  webhooks           Webhook[]
  creditPurchases    CreditPurchase[]
  falCompositeVideos FalCompositeVideo[]

  @@index([email])
  @@index([plan])
  @@index([stripeCustomerId])
  @@index([subscriptionStatus])
}

enum Plan {
  free        // Legacy - treat same as pending
  pending     // User registered but hasn't subscribed
  starter     // 3 minutes/month
  pro         // 20 minutes/month
  enterprise  // 60 minutes/month
}

enum SubscriptionStatus {
  incomplete          // Checkout started but not completed
  incomplete_expired  // Checkout expired
  trialing           // In trial period
  active             // Subscription is active
  past_due           // Payment failed but not yet canceled
  canceled           // Subscription was canceled
  unpaid             // Invoice unpaid
  paused             // Subscription paused
}

model CreditPurchase {
  id              String   @id @default(cuid())
  userId          String
  stripePaymentId String   @unique
  minutes         Int      // Minutes purchased
  amountPaid      Int      // Amount in cents
  createdAt       DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([stripePaymentId])
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

model ApiKey {
  id        String   @id @default(cuid())
  userId    String
  name      String
  key       String   @unique
  service   String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([key])
  @@index([service])
}

model Review {
  id           String   @id @default(cuid())
  userId       String
  businessName String
  reviewerName String
  reviewText   String
  rating       Int
  source       String
  createdAt    DateTime @default(now())

  user               User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  generatedVideos    GeneratedVideo[]
  falCompositeVideos FalCompositeVideo[]

  @@index([userId])
  @@index([source])
  @@index([rating])
}

model GeneratedVideo {
  id           String      @id @default(cuid())
  userId       String
  reviewId     String
  url          String?
  thumbnailUrl String?
  avatarStyle  String
  duration     Int?
  aspectRatio  String      @default("9:16")
  status       VideoStatus @default(pending)
  createdAt    DateTime    @default(now())
  completedAt  DateTime?

  // Mirage/Captions.ai specific fields
  mirageOperationId  String?   @unique  // Operation ID for polling
  mirageCreatorName  String?            // AI Creator used
  mirageResolution   String?   @default("4k")
  generatedScript    String?            // AI-generated UGC script
  creditsUsed        Int?               // Mirage credits consumed
  errorMessage       String?            // Error details if failed

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  review Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([reviewId])
  @@index([status])
  @@index([mirageOperationId])
  @@index([userId, status])
}

enum VideoStatus {
  pending
  processing
  completed
  failed
}

model ActorPreset {
  id             String   @id @default(cuid())
  userId         String
  name           String
  description    String?
  avatarStyle    String
  category       String   // "male", "female", "neutral"
  ethnicity      String?
  ageGroup       String?  // "young-adult", "adult", "middle-aged", "senior"
  voiceSettings  Json     // VoiceSettings object
  visualSettings Json     // VisualSettings object
  thumbnailUrl   String?
  isDefault      Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, isDefault])
  @@index([category])
}

model Webhook {
  id          String        @id @default(cuid())
  userId      String
  name        String        // Friendly name for the webhook
  type        WebhookType   @default(custom)
  webhookUrl  String
  events      String[]      // Array of event types: ["video.completed", "video.failed", etc.]
  active      Boolean       @default(true)
  secret      String?       // Optional secret for signature verification
  metadata    Json?         // Additional configuration (e.g., Slack channel, Discord settings)
  lastTriggeredAt DateTime?
  failureCount    Int       @default(0)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, active])
  @@index([type])
  @@index([active])
}

enum WebhookType {
  slack
  discord
  email
  custom
}

// ============================================================================
// FAL AI Lip-Sync Video Generation (SadTalker)
// ============================================================================

model FalActor {
  id                String   @id @default(cuid())
  name              String   // Display name: "Sarah - Professional"
  slug              String   @unique // URL-friendly: "sarah-professional"
  gender            String   // "male", "female"
  style             String   // "professional", "casual", "energetic", "friendly"
  referenceImageUrl String   // Front-facing pose for SadTalker consistency
  thumbnailUrl      String   // Preview image for UI grid
  voiceId           String?  // OpenAI TTS voice: "alloy", "nova", "shimmer", etc.
  voicePrompt       String?  // Detailed voice description for VEO consistency (pitch, tone, accent, pace)
  description       String?  // Optional description for the actor
  isActive          Boolean  @default(true)
  sortOrder         Int      @default(0)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  compositeVideos FalCompositeVideo[]

  @@index([isActive])
  @@index([gender])
  @@index([style])
  @@index([sortOrder])
}

model FalCompositeVideo {
  id              String              @id @default(cuid())
  userId          String
  reviewId        String
  actorId         String

  // Scripts
  fullScript        String            // Complete generated script
  hookScript        String            // Hook portion (5-6s)
  testimonialScript String            // Main testimonial (10-20s)
  ctaScript         String            // Call to action (5-6s)

  // Configuration
  aspectRatio     String              @default("9:16")
  targetDuration  Int                 // Total target duration in seconds (20-35)
  voiceId         String              @default("nova") // OpenAI TTS voice used

  // Output
  finalVideoUrl   String?
  thumbnailUrl    String?
  actualDuration  Int?                // Actual duration after generation

  // Status tracking
  status          FalCompositeStatus  @default(pending)
  currentClip     Int                 @default(0) // Which clip is being generated
  totalClips      Int                 @default(3) // Total clips to generate
  errorMessage    String?

  // Timestamps
  createdAt       DateTime            @default(now())
  completedAt     DateTime?

  // Relations
  user   User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  review Review   @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  actor  FalActor @relation(fields: [actorId], references: [id])
  clips  FalClip[]

  @@index([userId])
  @@index([reviewId])
  @@index([actorId])
  @@index([status])
  @@index([userId, status])
}

model FalClip {
  id               String   @id @default(cuid())
  compositeVideoId String
  clipType         String   // "hook", "testimonial", "cta"
  clipIndex        Int      // Order within composite (0, 1, 2, ...)
  scriptContent    String   // The text for this clip

  // TTS tracking
  audioUrl         String?  // URL of generated TTS audio

  // FAL SadTalker tracking
  falRequestId     String?  @unique // FAL request ID for polling

  // Output
  videoUrl         String?  // URL of generated video clip
  duration         Int?     // Actual duration in seconds

  // Status
  status           String   @default("pending") // pending, generating_audio, generating_video, completed, failed
  errorMessage     String?

  // Timestamps
  createdAt        DateTime @default(now())
  completedAt      DateTime?

  // Relations
  compositeVideo FalCompositeVideo @relation(fields: [compositeVideoId], references: [id], onDelete: Cascade)

  @@index([compositeVideoId])
  @@index([falRequestId])
  @@index([status])
}

enum FalCompositeStatus {
  pending           // Initial state
  generating_clips  // Clips being generated (TTS + SadTalker)
  stitching         // FFmpeg combining clips
  completed
  failed
}
